<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Revisiting the stencil exercise #  We&rsquo;ll revisit the stencil computation that we used when looking at vectorisation. This time, we&rsquo;re going to look at parallelisation with OpenMP, as well as some profiling tools.
Obtaining and compiling the code #  If you already downloaded the code from the previous exercise you already have the code, otherwise get the tar archive and unpack it.
This time we&rsquo;ll be working in the openmp subdirectory:"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="OpenMP: stencils & profiling"><meta property="og:description" content="Revisiting the stencil exercise #  We&rsquo;ll revisit the stencil computation that we used when looking at vectorisation. This time, we&rsquo;re going to look at parallelisation with OpenMP, as well as some profiling tools.
Obtaining and compiling the code #  If you already downloaded the code from the previous exercise you already have the code, otherwise get the tar archive and unpack it.
This time we&rsquo;ll be working in the openmp subdirectory:"><meta property="og:type" content="article"><meta property="og:url" content="https://teaching.wence.uk/phys52015/exercises/openmp-stencil/"><meta property="article:modified_time" content="2020-10-28T10:03:14+00:00"><title>OpenMP: stencils & profiling | PHYS52015 – Introduction to HPC</title><link rel=manifest href=/phys52015/manifest.json><link rel=icon href=/phys52015/favicon.png type=image/x-icon><link rel=stylesheet href=/phys52015/book.min.bf7f3e732f1a68bc04f2ce50cc8c8a462404f04066d1e404f002f2914662d55d.css integrity="sha256-v38+cy8aaLwE8s5QzIyKRiQE8EBm0eQE8ALykUZi1V0="></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><div class=book-brand><img class=book-center src=/phys52015/logo.svg alt=Logo><h2><a href=/phys52015>PHYS52015 – Introduction to HPC</a></h2></div><ul><li><span>Administrivia</span><ul><li><a href=/phys52015/setup/hamilton-quickstart/>Hamilton access & quickstart</a></li><li><a href=/phys52015/setup/byod/>Local setup</a></li><li><a href=/phys52015/setup/configuration/>ssh configuration</a></li><li><a href=/phys52015/setup/unix/>Unix resources</a></li></ul></li><li><span>Exercises</span><ul><li><a href=/phys52015/exercises/hello/>Parallel Hello World</a></li><li><a href=/phys52015/exercises/vectorisation-loop/>Vectorisation: loops with conditionals</a></li><li><a href=/phys52015/exercises/vectorisation-stencil/>Vectorisation: stencils</a></li><li><a href=/phys52015/exercises/openmp-loop/>OpenMP: parallel loops</a></li><li><a href=/phys52015/exercises/openmp-stencil/ class=active>OpenMP: stencils & profiling</a></li><li><a href=/phys52015/exercises/mpi-pi/>MPI: Calculating π</a></li><li><a href=/phys52015/exercises/mpi-stencil/>MPI: halo exchanges</a></li></ul></li><li><span>Notes</span><ul><li><a href=/phys52015/notes/introduction/>Introduction and motivation</a></li><li><span>Theory & concepts</span><ul><li><a href=/phys52015/notes/theory/scaling-laws/>Parallel scaling laws</a></li><li><a href=/phys52015/notes/theory/hardware-parallelism/>Parallelism in hardware: an overview</a></li><li><a href=/phys52015/notes/theory/concepts/>Parallel patterns</a></li></ul></li><li><a href=/phys52015/notes/vectorisation/>Vectorisation</a><ul><li><a href=/phys52015/notes/vectorisation/compiler/>Compiler autovectorisation</a></li></ul></li><li><a href=/phys52015/notes/openmp/>OpenMP</a><ul><li><a href=/phys52015/notes/openmp/openmp-collectives/>Collectives</a></li><li><a href=/phys52015/notes/openmp/openmp-loop-parallelism/>Loop parallelism</a></li><li><a href=/phys52015/notes/openmp/openmp-tasks/>Task parallelism</a></li></ul></li><li><a href=/phys52015/notes/mpi/>MPI</a><ul><li><a href=/phys52015/notes/mpi/mpi-ptp/>Point-to-point messaging</a></li><li><a href=/phys52015/notes/mpi/mpi-collectives/>Collectives</a></li><li><a href=/phys52015/notes/mpi/mpi-advanced/>Advanced topics</a></li></ul></li></ul></li><li><a href=/phys52015/coursework/>Coursework: parallel dense linear algebra</a><ul></ul></li><li><a href=/phys52015/resources/>Further resources</a></li><li><a href=/phys52015/acknowledgements/>Acknowledgements</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/phys52015/svg/menu.svg class=book-icon alt=Menu></label>
<strong>OpenMP: stencils & profiling</strong>
<label for=toc-control></label></div></header><article class=markdown><h1 id=revisiting-the-stencil-exercise>Revisiting the stencil exercise
<a class=anchor href=#revisiting-the-stencil-exercise>#</a></h1><p>We&rsquo;ll revisit the stencil computation that we used when <a href=https://teaching.wence.uk/phys52015/exercises/vectorisation-stencil/>looking at
vectorisation</a>. This time, we&rsquo;re
going to look at parallelisation with OpenMP, as well as some
profiling tools.</p><h2 id=obtaining-and-compiling-the-code>Obtaining and compiling the code
<a class=anchor href=#obtaining-and-compiling-the-code>#</a></h2><p>If you already downloaded the code from the <a href=https://teaching.wence.uk/phys52015/exercises/vectorisation-stencil/>previous exercise</a> you already have the code, otherwise
get the <a href=https://teaching.wence.uk/phys52015/code/blur_image.tgz>tar archive</a> and unpack it.</p><p>This time we&rsquo;ll be working in the <code>openmp</code> subdirectory:</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-sh data-lang=sh>$ <span style=color:#111>cd</span> blur_image/openmp/
$ ls
Makefile  filters.c io.c      main.c    proto.h
</code></pre></div><p>As before, build the executable with <code>make</code>.</p><blockquote class="book-hint info"><span>Don&rsquo;t forget to load the correct modules first.</span></blockquote><p>To confirm that everything works, run the code on one of the input
images to blur it.</p><h2 id=profiling>Profiling
<a class=anchor href=#profiling>#</a></h2><p>This code is very simple, so we can probably read all of it to figure
out where it is spending all its time. For larger codes, it&rsquo;s instead
best to use some kind of profiling to find out where to start looking.</p><p>Depending on the amount of detail you need there are a variety of
useful tools. If you have access to the Intel toolchain then
<a href=https://software.intel.com/content/www/us/en/develop/tools/vtune-profiler.html>VTune</a>
is quite good: we will use this later when looking at OpenMP
performance.</p><p>If you want a rough idea with callstack information, we can use
<code>gprof</code>. Although this is not a panacea. In many cases <a href=https://en.wikipedia.org/wiki/Profiling_%28computer_programming%29#Statistical_profilers>statistical
profiling</a>
is more useful, especially if it records line-by-line information. On
linux you can do this with
<a href=https://perf.wiki.kernel.org/index.php/Main_Page>perf</a>, but it is
not available on Hamilton or COSMA.</p><blockquote class=task><h3>Task</h3><span>We will use <code>gprof</code> here. It uses a combination of source code
annotation and statistical sampling to generate approximate call
graphs. Add the appropriate <code>-pg</code> flags to the <code>CFLAGS</code> variable in
the makefile and recompile. Run the code again.</span></blockquote><blockquote class="book-hint info"><span>Reminder, as always, to use the batch system and submit your code to a
compute node. You&rsquo;ll need to produce an appropriate SLURM submission
script for this.</span></blockquote><blockquote class=question><h3>Question</h3><span>Look at the output from <code>gprof</code>. Which function takes the bulk of the
runtime?</span></blockquote><h2 id=parallel-scaling>Parallel scaling
<a class=anchor href=#parallel-scaling>#</a></h2><p>The code is annotated with OpenMP <code>#pragma</code>s. Remove the profiling
flags from the makefile and add the relevant compiler flags to enabled
OpenMP parallelisation.</p><blockquote class=task><h3>Task</h3><span><p>Investigate the parallel scaling by running the code in parallel using
different numbers of threads</p><details><summary>Hint</summary><div class=markdown-inner>Remember that you control the number of threads by setting the
<code>OMP_NUM_THREADS</code> environment variable. Don&rsquo;t forget to do this <em>in
your submission script</em>.</div></details><div class=book-tabs><input type=radio class=toggle name=tabs-threads id=tabs-threads-0 checked>
<label for=tabs-threads-0>Hamilton</label><div class="book-tabs-content markdown-inner">Use 1, 2, 4, 6, 8, 16, 24, 32, and 48 threads.</div><input type=radio class=toggle name=tabs-threads id=tabs-threads-1>
<label for=tabs-threads-1>COSMA</label><div class="book-tabs-content markdown-inner">Use 1, 2, 4, 6, 8, 16, and 32 threads.</div></div><p>Produce a plot of your results comparing the observed speedup to an
ideal (linear speedup). What do you observe?</p></span></blockquote><h2 id=profiling-with-intel-vtuneamplifier>Profiling with Intel VTune/Amplifier
<a class=anchor href=#profiling-with-intel-vtuneamplifier>#</a></h2><p>We&rsquo;re now going to do more detailed profiling using
<a href=https://software.intel.com/content/www/us/en/develop/tools/vtune-profiler.html>VTune</a>.</p><p>Load the relevant modules to gain access to VTune. On Hamilton this
comes with the <code>intel/xe_2018.2</code> module you loaded to access the
compilers, on COSMA you&rsquo;ll need to load <code>vtune/2019-update4</code>.</p><p>Use four OpenMP threads for this experiment.</p><blockquote class=task><h3>Task</h3><span><p>Run the code performing an HPC analysis</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-sh data-lang=sh>$ amplxe-cl -collect hpc-performance ./blur input.ppm output.ppm
</code></pre></div></span></blockquote><p>For this next bit, you&rsquo;ll need to launch a graphical program on the
login node. So that it displays locally, you need to ssh in with <em>X
forwarding enabled</em>. This means you need to run <code>ssh -Y</code> rather than
just <code>ssh</code>.</p><p>An alternative is to have the Intel tools available locally on your
system. A student license is available free. You should then transfer
the results of the profiling to your local machine with <code>scp</code> and
analyse them there.</p><blockquote class=question><h3>Question</h3><span><p>You can look at the results using the graphical interface
<code>amplxe-gui</code>.</p><p>What fraction of the runtime does the code spend in the serial and
parallel parts?</p><p>What are the main hotspots in the serial and parallel parts?</p></span></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/wenceorg/phys52015/commit/5cc02b7b9a17f600dedbadb5ef1f13eb3e9fc59b title="Last modified by Lawrence Mitchell | October 28, 2020" target=_blank rel=noopener><img src=/phys52015/svg/calendar.svg class=book-icon alt=Calendar>
<span>October 28, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/wenceorg/phys52015/edit/main/site/content/exercises/openmp-stencil.md target=_blank rel=noopener><img src=/phys52015/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap align-right"><p>© 2020&ndash; <a href=mailto:lawrence@wence.uk>Lawrence Mitchell</a>, <a href="https://www.dur.ac.uk/physics/staff/profiles/?mode=staff&id=16712">Christian Arnold</a> & <a href=https://www.dur.ac.uk/>Durham University</a>.</p><p><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=/phys52015/cc-by-sa.svg></a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative
Commons Attribution-ShareAlike 4.0 International License</a>.</p></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>