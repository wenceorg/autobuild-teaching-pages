<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Obtained vectorised code #  If we write code that we would like to be vectorised, we have multiple different options available to us on how to obtain it. We&rsquo;ll first list some approaches, briefly detail their strengths and weaknesses, and then go into more detail on the approach that we&rsquo;ll be using in this course.
First, some general advice. It is tempting to think of vectorisation as an optimisation that we can apply locally to our code."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Compiler autovectorisation"><meta property="og:description" content="Obtained vectorised code #  If we write code that we would like to be vectorised, we have multiple different options available to us on how to obtain it. We&rsquo;ll first list some approaches, briefly detail their strengths and weaknesses, and then go into more detail on the approach that we&rsquo;ll be using in this course.
First, some general advice. It is tempting to think of vectorisation as an optimisation that we can apply locally to our code."><meta property="og:type" content="article"><meta property="og:url" content="https://teaching.wence.uk/phys52015/notes/vectorisation/compiler/"><meta property="article:modified_time" content="2020-10-19T13:23:40+01:00"><title>Compiler autovectorisation | PHYS52015 – Introduction to HPC</title><link rel=manifest href=/phys52015/manifest.json><link rel=icon href=/phys52015/favicon.png type=image/x-icon><link rel=stylesheet href=/phys52015/book.min.bf7f3e732f1a68bc04f2ce50cc8c8a462404f04066d1e404f002f2914662d55d.css integrity="sha256-v38+cy8aaLwE8s5QzIyKRiQE8EBm0eQE8ALykUZi1V0="></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><div class=book-brand><img class=book-center src=/phys52015/logo.svg alt=Logo><h2><a href=/phys52015>PHYS52015 – Introduction to HPC</a></h2></div><ul><li><span>Administrivia</span><ul><li><a href=/phys52015/setup/hamilton-quickstart/>Hamilton access & quickstart</a></li><li><a href=/phys52015/setup/byod/>Local setup</a></li><li><a href=/phys52015/setup/configuration/>ssh configuration</a></li><li><a href=/phys52015/setup/unix/>Unix resources</a></li></ul></li><li><span>Exercises</span><ul><li><a href=/phys52015/exercises/hello/>Parallel Hello World</a></li><li><a href=/phys52015/exercises/vectorisation-loop/>Vectorisation: loops with conditionals</a></li><li><a href=/phys52015/exercises/vectorisation-stencil/>Vectorisation: stencils</a></li><li><a href=/phys52015/exercises/openmp-loop/>OpenMP: parallel loops</a></li><li><a href=/phys52015/exercises/openmp-stencil/>OpenMP: stencils & profiling</a></li><li><a href=/phys52015/exercises/mpi-pi/>MPI: Calculating π</a></li><li><a href=/phys52015/exercises/mpi-stencil/>MPI: halo exchanges</a></li></ul></li><li><span>Notes</span><ul><li><a href=/phys52015/notes/introduction/>Introduction and motivation</a></li><li><span>Theory & concepts</span><ul><li><a href=/phys52015/notes/theory/scaling-laws/>Parallel scaling laws</a></li><li><a href=/phys52015/notes/theory/hardware-parallelism/>Parallelism in hardware: an overview</a></li><li><a href=/phys52015/notes/theory/concepts/>Parallel patterns</a></li></ul></li><li><a href=/phys52015/notes/vectorisation/>Vectorisation</a><ul><li><a href=/phys52015/notes/vectorisation/compiler/ class=active>Compiler autovectorisation</a></li></ul></li><li><a href=/phys52015/notes/openmp/>OpenMP</a><ul><li><a href=/phys52015/notes/openmp/openmp-collectives/>Collectives</a></li><li><a href=/phys52015/notes/openmp/openmp-loop-parallelism/>Loop parallelism</a></li><li><a href=/phys52015/notes/openmp/openmp-tasks/>Task parallelism</a></li></ul></li><li><a href=/phys52015/notes/mpi/>MPI</a><ul><li><a href=/phys52015/notes/mpi/mpi-ptp/>Point-to-point messaging</a></li><li><a href=/phys52015/notes/mpi/mpi-collectives/>Collectives</a></li><li><a href=/phys52015/notes/mpi/mpi-advanced/>Advanced topics</a></li></ul></li></ul></li><li><a href=/phys52015/coursework/>Coursework: parallel dense linear algebra</a><ul></ul></li><li><a href=/phys52015/resources/>Further resources</a></li><li><a href=/phys52015/acknowledgements/>Acknowledgements</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/phys52015/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Compiler autovectorisation</strong>
<label for=toc-control></label></div></header><article class=markdown><h1 id=obtained-vectorised-code>Obtained vectorised code
<a class=anchor href=#obtained-vectorised-code>#</a></h1><p>If we write code that we would like to be vectorised, we have multiple
different options available to us on how to obtain it. We&rsquo;ll first
list some approaches, briefly detail their strengths and weaknesses,
and then go into more detail on the approach that we&rsquo;ll be using in
this course.</p><p>First, some general advice. It is tempting to think of vectorisation
as an optimisation that we can apply locally to our code. In fact, we
should not think of it this way. Recalling <a href=https://teaching.wence.uk/phys52015/notes/theory/scaling-laws/#amdahl>Amdahl&rsquo;s Law</a>, if we only speed up a small part of our
code, we might not see a particular benefit. In addition,
vectorisation might necessitate some algorithmic restructuring and
data layout transformations. These are changes which have an effect on
the performance of the whole code.</p><p>As such, I advocate designing with vectorisation (and more generally
parallelism) in mind <em>from the start</em>. Keep this in mind when we&rsquo;re
looking at the examples of vectorisable loops in isolation.</p><h2 id=programming-approaches>Programming approaches
<a class=anchor href=#programming-approaches>#</a></h2><p>In order of increasing programmer control and complication, we have
broadly four options available to us to exploit vector hardware.</p><ol><li><p>Fully automatic via the compiler</p><p>Here we rely on automated analysis from the compiler to find
vectorisable parts of the code and apply the appropriate
transformation</p></li><li><p>Partially automatic: compiler + pragma-based source annotations</p><p>In this case, we still want the compiler to do the work, but we
will give it some hints by annotating our code with extra
information.</p></li><li><p>Explicit use of intrinsics</p><p>Here we use special variable types and replace normal code by calls
to functions that are turned into inline assembly. This is slightly
like writing &ldquo;semi-portable&rdquo; assembly. This is quite a complicated
approach, and makes your code far less readable.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#75715e>/* Before */</span>
<span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span>
   <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
<span style=color:#75715e>/* Vectorised with AVX2 intrinsics */</span>
<span style=color:#111>__m256d</span> <span style=color:#111>av</span><span style=color:#111>,</span> <span style=color:#111>bv</span><span style=color:#111>,</span> <span style=color:#111>cv</span><span style=color:#111>;</span>
<span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#111>av</span> <span style=color:#f92672>=</span> <span style=color:#111>_mm256_load_pd</span><span style=color:#111>(</span><span style=color:#111>a</span> <span style=color:#f92672>+</span> <span style=color:#111>i</span><span style=color:#111>);</span>
    <span style=color:#111>bv</span> <span style=color:#f92672>=</span> <span style=color:#111>_mm256_load_pd</span><span style=color:#111>(</span><span style=color:#111>b</span> <span style=color:#f92672>+</span> <span style=color:#111>i</span><span style=color:#111>);</span>
    <span style=color:#111>cv</span> <span style=color:#f92672>=</span> <span style=color:#111>_mm256_add_pd</span><span style=color:#111>(</span><span style=color:#111>av</span><span style=color:#111>,</span> <span style=color:#111>bv</span><span style=color:#111>);</span>
    <span style=color:#111>_mm256_store_pd</span><span style=color:#111>(</span><span style=color:#111>c</span> <span style=color:#f92672>+</span> <span style=color:#111>i</span><span style=color:#111>,</span> <span style=color:#111>cv</span><span style=color:#111>);</span>
<span style=color:#111>}</span>
</code></pre></div><blockquote class="book-hint info"><span>If you want to
know what these functions do, see the interactive <a href=https://software.intel.com/sites/landingpage/IntrinsicsGuide/>Intel intrinsics
guide</a></span></blockquote><p>This approach is not (immediately) portable to different vector
instruction sets (e.g. for AVX512 the load function is spelt
<code>_mm512_load_pd</code> rather than <code>_mm256_load_pd</code>). If going down this
route it&rsquo;s therefore best to wrap these things behind a library.
For C++, <a href=https://www.agner.org>Agner Fog</a> has a <a href=https://github.com/vectorclass/version2>nice
one</a>.</p></li><li><p>Explicitly writing assembly</p><p>This is similar to the previous case with intrinsics, but now we
don&rsquo;t rely on the compiler for control flow or register allocation
and have to do everything by hand.</p></li></ol><p>There is also a further class of methods that might rely on using
domain-specific languages or language extensions. We won&rsquo;t touch on
them here.</p><p>Given the complexity, and lack of portability, in the third and fourth
options. In this course we will only look at vectorisation available
via compiler optimisations, sometimes helped by pragma annotations.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/wenceorg/phys52015/commit/d44334cbcb0012dd588c96d5c1f0fa4a94c1f7c2 title="Last modified by Lawrence Mitchell | October 19, 2020" target=_blank rel=noopener><img src=/phys52015/svg/calendar.svg class=book-icon alt=Calendar>
<span>October 19, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/wenceorg/phys52015/edit/main/site/content/notes/vectorisation/compiler.md target=_blank rel=noopener><img src=/phys52015/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap align-right"><p>© 2020&ndash; <a href=mailto:lawrence@wence.uk>Lawrence Mitchell</a>, <a href="https://www.dur.ac.uk/physics/staff/profiles/?mode=staff&id=16712">Christian Arnold</a> & <a href=https://www.dur.ac.uk/>Durham University</a>.</p><p><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=/phys52015/cc-by-sa.svg></a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative
Commons Attribution-ShareAlike 4.0 International License</a>.</p></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>