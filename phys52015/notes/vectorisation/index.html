<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Vectorisation #  As we saw briefly when introducing, the parallelism available in supercomputing hardware offers vector units at the lowest level.
Although the type of things we can typically do with vectorisation are quite limited (compared to other forms of parallelisation), they allow us to introduce a number of concepts. Moreover, it is unfortunately the case that we need to be aware of vectorisation concepts if we want to write high-performance code."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Vectorisation"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://teaching.wence.uk/phys52015/notes/vectorisation/"><title>Vectorisation | PHYS52015 – Introduction to HPC</title><link rel=manifest href=/phys52015/manifest.json><link rel=icon href=/phys52015/favicon.png type=image/x-icon><link rel=stylesheet href=/phys52015/book.min.0cb0b7d6a1ed5d0e95321cc15edca4d6e9cc406149d1f4a3f25fd532f6a3bb38.css integrity="sha256-DLC31qHtXQ6VMhzBXtyk1unMQGFJ0fSj8l/VMvajuzg="><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true},{left:"$",right:"$",display:false},{left:"\\(",right:"\\)",display:false},{left:"\\[",right:"\\]",display:true}]})});</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><div class=book-brand><img class=book-center src=/phys52015/logo.svg alt=Logo><h2><a href=/phys52015>PHYS52015 – Introduction to HPC</a></h2></div><ul><li><span>Administrivia</span><ul><li><a href=/phys52015/setup/remote/>Remote editing/development</a></li><li><a href=/phys52015/setup/hamilton-quickstart/>Hamilton access & quickstart</a></li><li><a href=/phys52015/setup/byod/>Local setup</a></li><li><a href=/phys52015/setup/configuration/>ssh configuration</a></li><li><a href=/phys52015/setup/unix/>Unix resources</a></li></ul></li><li><span>Exercises</span><ul><li><a href=/phys52015/exercises/hello/>Parallel Hello World</a></li><li><a href=/phys52015/exercises/vectorisation-loop/>Vectorisation: loops with conditionals</a></li><li><a href=/phys52015/exercises/vectorisation-stencil/>Vectorisation: stencils</a></li><li><a href=/phys52015/exercises/openmp-loop/>OpenMP: parallel loops</a></li><li><a href=/phys52015/exercises/openmp-stencil/>OpenMP: stencils</a></li><li><a href=/phys52015/exercises/openmp-reduction/>OpenMP: synchronisation</a></li><li><a href=/phys52015/exercises/mpi-ring/>MPI: messages round a ring</a></li><li><a href=/phys52015/exercises/mpi-pi/>MPI: Calculating π</a></li><li><a href=/phys52015/exercises/mpi-ping-pong/>MPI: ping-pong latency</a></li><li><a href=/phys52015/exercises/mpi-collectives/>MPI: simple collectives</a></li><li><a href=/phys52015/exercises/mpi-stencil/>MPI: domain decomposition and halo exchanges</a></li></ul></li><li><span>Notes</span><ul><li><a href=/phys52015/notes/introduction/>Introduction and motivation</a></li><li><span>Theory & concepts</span><ul><li><a href=/phys52015/notes/theory/scaling-laws/>Parallel scaling laws</a></li><li><a href=/phys52015/notes/theory/hardware-parallelism/>Parallelism in hardware: an overview</a></li><li><a href=/phys52015/notes/theory/concepts/>Parallel patterns</a></li></ul></li><li><a href=/phys52015/notes/vectorisation/ class=active>Vectorisation</a><ul><li><a href=/phys52015/notes/vectorisation/compiler/>Compiler autovectorisation</a></li></ul></li><li><a href=/phys52015/notes/openmp/>OpenMP</a><ul><li><a href=/phys52015/notes/openmp/intro/>What is OpenMP?</a></li><li><a href=/phys52015/notes/openmp/loop-parallelism/>Loop parallelism</a></li><li><a href=/phys52015/notes/openmp/collectives/>Collectives</a></li></ul></li><li><a href=/phys52015/notes/mpi/>MPI</a><ul><li><a href=/phys52015/notes/mpi/point-to-point/>Point-to-point messaging in MPI</a></li><li><a href=/phys52015/notes/mpi/point-to-point-nb/>Non-blocking point-to-point messaging</a></li><li><a href=/phys52015/notes/mpi/collectives/>Collectives</a></li><li><a href=/phys52015/notes/mpi/advanced/>Advanced topics</a></li></ul></li></ul></li><li><a href=/phys52015/coursework/>Coursework: parallel dense linear algebra</a><ul></ul></li><li><a href=/phys52015/resources/>Further resources</a></li><li><a href=/phys52015/acknowledgements/>Acknowledgements</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/phys52015/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Vectorisation</strong>
<label for=toc-control></label></div></header><article class=markdown><h1 id=vectorisation>Vectorisation
<a class=anchor href=#vectorisation>#</a></h1><p>As we saw briefly when <a href=https://teaching.wence.uk/phys52015/notes/theory/hardware-parallelism/#instruction-parallelism>introducing</a>, the parallelism
available in supercomputing hardware offers vector units at the lowest
level.</p><p>Although the type of things we can typically do with vectorisation are
quite limited (compared to other forms of parallelisation), they allow
us to introduce a number of concepts. Moreover, it is unfortunately
the case that we need to be aware of vectorisation concepts if we want
to write high-performance code.</p><p>Vectorisation allows us to realise <em>loop-level data parallelism</em>. That is,
if we have code that contains loops that are <a href=https://teaching.wence.uk/phys52015/notes/theory/concepts/#data-parallelism>data parallel</a>, they are potentially candidates
for vectorisation.</p><p>Fortunately, lots of scientific computing relies on numerical kernels
that do exhibit data parallelism (and hence can be vectorised).</p><h2 id=vectorisable-loops>Vectorisable loops
<a class=anchor href=#vectorisable-loops>#</a></h2><p>Not all loops that we might write can be vectorised. In fact, the set
of conditions we need our loop to obey is quite strict. At a high
level what is going on is that take our loop iterations and do them,
not one at a time, but in chunks of the <em>vector width</em>.</p><p>For example, recall our simple addition of two vectors</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
</code></pre></div><div class="book-columns flex flex-wrap"><div class="flex-even markdown-inner"><figure style=width:75%><img class=scaled src=https://teaching.wence.uk/phys52015/images/manual/scalaradd.svg alt="Scalar addition, one element at a time"><figcaption><p>Scalar addition, one element at a time</p></figcaption></figure></div><div class="flex-even markdown-inner"><figure style=width:75%><img class=scaled src=https://teaching.wence.uk/phys52015/images/manual/vectoradd.svg alt="Vector addition, four elements at a time"><figcaption><p>Vector addition, four elements at a time</p></figcaption></figure></div></div><p>In this example, we take four iterations of the loop at once and do
them in one go with vector instructions.</p><p>It is a little as if we had written our loop body as</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>];</span>
<span style=color:#111>}</span>
</code></pre></div><p>and now we do all the instructions in this loop body in one go. This
is called <em>loop unrolling</em> (because we unrolled the loop).</p><blockquote class="book-hint warning"><span>You should basically never have to do loop unrolling by hand like
this. Rely on your compiler to do it!</span></blockquote><details><summary>What if N isn't evenly divisible by 4?</summary><div class=markdown-inner><p>In the case that N isn&rsquo;t evenly divisible by four, we have to have
some cleanup code afterwards. So we would have written something like</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#75715e>/* Main loop body (vectorisable) */</span>
<span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>(</span><span style=color:#111>N</span><span style=color:#f92672>/</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>];</span>
<span style=color:#111>}</span>

<span style=color:#75715e>/* Scalar cleanup code */</span>
<span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#111>(</span><span style=color:#111>N</span><span style=color:#f92672>/</span><span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
<span style=color:#111>}</span>
</code></pre></div></div></details><p>OK, so now we have four statements that we can execute simultaneously.
But are we allowed to do so?</p><p>For our loop to be vectorisable, it needs to satisfy six conditions:</p><ol><li>The loop must be <em>countable</em> (on entry, we need to know how many
iterations we have);</li><li>It must be single-entry and single-exit;</li><li>No branching in the loop body (but see details below);</li><li>It must be the innermost loop;</li><li>There must be no function calls (but see details below);</li><li>There must be no <em>dependencies</em> between loop iterations.</li></ol><p>Let&rsquo;s treat these in more details in turn.</p><h3 id=countable-loops>Countable loops
<a class=anchor href=#countable-loops>#</a></h3><p>A countable loop is one with no data-dependent exits. For example,
this loop is not countable</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
  <span style=color:#75715e>/* Break exits the loop */</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><p>When we start the loop, we know the value of <code>N</code>, but we don&rsquo;t know
the value of the arrays, so we can&rsquo;t determine how many iterations
we&rsquo;re going to execute. If we think of unrolling the loop, we would
have</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>];</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>];</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>];</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><p>Remember that vector instructions want to perform these four
summations in one go. But if we did that, would have rearranged the
loop body to be</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>];</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>];</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#00a8c8>break</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><p>So we always perform four updates, and then break if any of the
conditions are satisfied. This <em>does not</em> produce the same result as
the sequential loop, so vectorisation is invalid.</p><blockquote class=exercise><h3>Exercise</h3><span><p>Convince yourself that this transformation (moving the breaks to the
end) is invalid by writing some code.</p><p>You could use this python snippet as a start</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-python data-lang=python><span style=color:#f92672>import</span> <span style=color:#111>numpy</span> <span style=color:#f92672>as</span> <span style=color:#111>np</span>
<span style=color:#111>a</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>logspace</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>,</span> <span style=color:#111>base</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#111>num</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>
<span style=color:#111>b</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>linspace</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>,</span> <span style=color:#111>num</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>
<span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>zeros_like</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)</span>
<span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)):</span>
    <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span>
    <span style=color:#00a8c8>if</span> <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>15</span><span style=color:#111>:</span>
        <span style=color:#00a8c8>break</span>
<span style=color:#00a8c8>print</span><span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>)</span>
</code></pre></div><details><summary>Solution</summary><div class=markdown-inner><p>The original code produces the output:</p><pre><code>[ 2.  4.  7. 12. 21.  0.  0.  0.]
</code></pre><p>Let&rsquo;s just unroll by 4 and see what happens</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-python data-lang=python><span style=color:#f92672>import</span> <span style=color:#111>numpy</span> <span style=color:#f92672>as</span> <span style=color:#111>np</span>
<span style=color:#111>a</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>logspace</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>,</span> <span style=color:#111>base</span><span style=color:#f92672>=</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#111>num</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>
<span style=color:#111>b</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>linspace</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>,</span> <span style=color:#111>num</span><span style=color:#f92672>=</span><span style=color:#ae81ff>8</span><span style=color:#111>)</span>
<span style=color:#111>c</span> <span style=color:#f92672>=</span> <span style=color:#111>np</span><span style=color:#f92672>.</span><span style=color:#111>zeros_like</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)</span>
<span style=color:#00a8c8>for</span> <span style=color:#111>i</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>),</span> <span style=color:#ae81ff>4</span><span style=color:#111>):</span>
    <span style=color:#00a8c8>for</span> <span style=color:#111>j</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#111>i</span><span style=color:#111>)):</span>
        <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#111>j</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#111>j</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#111>j</span><span style=color:#111>]</span>
    <span style=color:#111>breakp</span> <span style=color:#f92672>=</span> <span style=color:#111>False</span>
    <span style=color:#00a8c8>for</span> <span style=color:#111>j</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#ae81ff>4</span><span style=color:#111>,</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#111>i</span><span style=color:#111>)):</span>
        <span style=color:#00a8c8>if</span> <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#111>j</span><span style=color:#111>]</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>15</span><span style=color:#111>:</span>
            <span style=color:#111>breakp</span> <span style=color:#f92672>=</span> <span style=color:#111>True</span>
            <span style=color:#00a8c8>break</span>
    <span style=color:#00a8c8>if</span> <span style=color:#111>breakp</span><span style=color:#111>:</span>
        <span style=color:#00a8c8>break</span>
<span style=color:#00a8c8>print</span><span style=color:#111>(</span><span style=color:#111>c</span><span style=color:#111>)</span>
<span style=color:#f92672>=&gt;</span> <span style=color:#111>[</span>  <span style=color:#ae81ff>2.</span>   <span style=color:#ae81ff>4.</span>   <span style=color:#ae81ff>7.</span>  <span style=color:#ae81ff>12.</span>  <span style=color:#ae81ff>21.</span>  <span style=color:#ae81ff>38.</span>  <span style=color:#ae81ff>71.</span> <span style=color:#ae81ff>136.</span><span style=color:#111>]</span>
</code></pre></div><p>So we fill up three more array entries at the end. The reason being
that we should break when computing the entry at <code>c[4]</code>, but we don&rsquo;t
realise that until we&rsquo;ve executed another three iterations.</p></div></details></span></blockquote><h3 id=single-entry-single-exit-loops>Single-entry single-exit loops
<a class=anchor href=#single-entry-single-exit-loops>#</a></h3><p>This condition is actually an implication of the requirement for
countable loops. The single-exit rule means we can&rsquo;t have
data-dependent exits. Single-entry is similar, we can&rsquo;t jump into the
loop from somewhere (but you don&rsquo;t write <code>goto</code> anyway, so that&rsquo;s
fine).</p><h3 id=masked-assignment>No branching (&ldquo;straight-line&rdquo; code)
<a class=anchor href=#masked-assignment>#</a></h3><p>Since vector instructions carry out the same operation on data from
multiple elements of the original loop, different iterations should
not have different control flow. So <code>switch</code> statements are typically
not vectorised. That said, many conditionals can be implemented as
masked assignments, in which case vectorisation <em>is allowed</em>. Here is
an example of some code that would be vectorised, despite the
conditionals</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
   <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span> <span style=color:#111>{</span>
      <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
   <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
      <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
   <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></div><p>What happens is that the loop is unrolled and <em>both</em> branches of the
conditional are executed. The result is then combined using a
data-dependent mask.</p><figure style=width:75%><img class=scaled src=https://teaching.wence.uk/phys52015/images/manual/mask-registers.svg alt="Conditional assignment can be vectorised by using masking to blend results together."><figcaption><p>Conditional assignment can be vectorised by using masking to blend results together.</p></figcaption></figure><h3 id=innermost-loops>Innermost loops
<a class=anchor href=#innermost-loops>#</a></h3><p>Since we need straight-line code, the only loop in a loop nest that
can be vectorised is the innermost loop.</p><div class=highlight><div style=color:#272822;background-color:#fafafa><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#272822;background-color:#fafafa><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>j</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>j</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>M</span><span style=color:#111>;</span> <span style=color:#111>j</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
    <span style=color:#111>...</span>
  <span style=color:#111>}</span>
<span style=color:#111>}</span>
</code></pre></td></tr></table></div></div><p>The loop on line 1 cannot be vectorised, but the loop on line 2 can.</p><blockquote class="book-hint info"><span>Note that other optimisations might be performed that remove the inner
loop. For example, if <code>M</code> were compile-time known and small, the inner
loop over <code>j</code> might be completely unrolled, leaving the <code>i</code> loop a
candidate for vectorisation.</span></blockquote><h3 id=no-function-calls>No function calls
<a class=anchor href=#no-function-calls>#</a></h3><p>If we have a loop that contains a call to another function, it cannot
be vectorised unless we can &ldquo;see&rdquo; inside that other function to figure
out what is allowed. The intuition is straightforward, the function
might do anything at all, so unless we know what it is doing, we can&rsquo;t
be sure that it meets all the other conditions.</p><p>There are some exceptions. If the function is in the same compilation
unit (file) and is <em>inlined</em> (effectively pasting the function body
into the loop), then the loop may be vectorised. Similarly, builtin
mathematical functions are often recognised by compilers as
vectorisable.</p><h3 id=data-dep>No data dependencies in the loop
<a class=anchor href=#data-dep>#</a></h3><p>This is the most subtle, but also easy to get an intuition for.
Remember that conceptually the way we vectorise a loop is to <em>unroll</em>
it and then execute the resulting loop body statements <em>in parallel</em>.
For this to be valid, we must be able to execute the statements in any
order we like.</p><p>For example, this loop is not vectorisable</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span>
  <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
</code></pre></div><p>Since the \(i\)th iteration depends on the results of the
\(i-1\)th iteration.</p><blockquote class=exercise><h3>Exercise</h3><span><p>Write out the unrolled loop (unrolling by 4) and convince yourself
that you can&rsquo;t reorder the statements in the loop body while
maintaining the same semantics.</p><details><summary>Solution</summary><div class=markdown-inner>Since there is a dependency between neighbouring iterations, any
reordering of the statements results in a different result.</div></details></span></blockquote><p>This particular loop exhibits a <em>read-after-write</em> dependency, some
times called a <em>flow</em> dependency. These are &ldquo;true&rdquo; dependencies and
really inhibit parallelisation. There are also a number of other
types, <em>write-after-read</em> (also called anti-dependencies),
<em>write-after-write</em> (also called output dependencies), and
<em>read-after-read</em> (not really dependencies). As usual,
<a href=https://en.wikipedia.org/wiki/Data_dependency>wikipedia</a> has a good
summary. For our purposes, <em>read-after-write</em> are the difficult ones
to handle. The others can usually be refactored by introducing some
temporary variables (as discussed in the linked wikipedia article).
Typically, they then reveal a read-after-write dependency.</p><blockquote class=exercise><h3>Exercise</h3><span><p>Consider vectorising for a 4-wide vector unit (that is, four additions
can be done at once). Do you think the following loop is vectorisable?</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>size_t</span> <span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>4</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
<span style=color:#111>}</span>
</code></pre></div><p>Explain your reasoning.</p><details><summary>Solution</summary><div class=markdown-inner><p>This one can be vectorised. Although there is a dependency, it is
at a distance of four statements away. So if we chunk the statements
into blocks of four, we see that we can reorder within the blocks
without changing the answer. So if we&rsquo;re vectorising four statements
at a time, this code is fine.</p><p>See the optimisation report from the Intel compiler
<a href=https://gcc.godbolt.org/z/5Y8oP4>here</a>.</p></div></details></span></blockquote><p>Section 4.2 of Intel&rsquo;s <a href=https://software.intel.com/sites/default/files/m/4/8/8/2/a/31848-CompilerAutovectorizationGuide.pdf>compiler vectorisation
guide</a>
has more details on these dependencies.</p><h2 id=summary>Summary
<a class=anchor href=#summary>#</a></h2><p>To get best performance out of modern hardware, we need to employ
vectorisation of loop-level computations. This is easiest if we have
a <a href=https://teaching.wence.uk/phys52015/notes/theory/concepts/#data-parallelism>data parallel</a> loop.</p><p>Not all loops are vectorisable, we saw a set of requirements that they
must satisfy. <a href=https://teaching.wence.uk/phys52015/notes/vectorisation/compiler/>Next</a>, we&rsquo;ll look at
different approaches to realising vector parallelism.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/wenceorg/phys52015/commit/490c8754a5eec69cdd49b5fe2fc2c9ef66fae72d title="Last modified by Lawrence Mitchell | November 30, 2020" target=_blank rel=noopener><img src=/phys52015/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 30, 2020</span></a></div><div><a class="flex align-center" href=https://github.com/wenceorg/phys52015/edit/main/site/content/notes/vectorisation/_index.md target=_blank rel=noopener><img src=/phys52015/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap align-right"><p>© 2020&ndash; <a href=mailto:lawrence@wence.uk>Lawrence Mitchell</a>, <a href="https://www.dur.ac.uk/physics/staff/profiles/?mode=staff&id=16712">Christian Arnold</a> & <a href=https://www.dur.ac.uk/>Durham University</a>.</p><p><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=/phys52015/cc-by-sa.svg></a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative
Commons Attribution-ShareAlike 4.0 International License</a>.</p></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div></main></body></html>